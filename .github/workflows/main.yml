name: CI/CD Pipeline - EC2 Deployment with RDS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # ==================== BUILD & TEST ====================
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Frontend - Install and Lint
        working-directory: ./frontend
        run: |
          npm ci
          npm run lint || echo "Lint completed"

      - name: Backend - Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Validate Docker Compose
        run: docker compose -f docker-compose.yml config

  # ==================== BUILD & PUSH DOCKER IMAGES ====================
  docker-build-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get short SHA
        id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/3-tier-backend:${{ steps.sha.outputs.short_sha }}
            ${{ secrets.DOCKER_USERNAME }}/3-tier-backend:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            REACT_APP_API_BASE_URL=http://${{ secrets.EC2_HOST }}:3500
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/3-tier-frontend:${{ steps.sha.outputs.short_sha }}
            ${{ secrets.DOCKER_USERNAME }}/3-tier-frontend:latest

  # ==================== DEPLOY TO EC2 ====================
  deploy-to-ec2:
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            mkdir -p /home/${{ secrets.EC2_USERNAME }}/3-tier-app
            cd /home/${{ secrets.EC2_USERNAME }}/3-tier-app

            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git .
            fi

            docker pull ${{ secrets.DOCKER_USERNAME }}/3-tier-backend:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/3-tier-frontend:latest

            docker compose down || true

            export MYSQL_HOST=${{ secrets.MYSQL_HOST }}
            export MYSQL_USER=${{ secrets.MYSQL_USER }}
            export MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
            export MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}

            docker compose up -d

            echo "Waiting for containers to start..."
            sleep 10
            
            echo "Checking container status..."
            docker ps -a
            
            echo "Backend logs (last 20 lines):"
            docker logs backend_app --tail 20 || true
            
            docker image prune -af --filter "until=24h"

  # ==================== HEALTH CHECK ====================
  health-check:
    needs: deploy-to-ec2
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for App Startup
        run: sleep 30

      - name: Verify Containers on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Docker Containers Status ==="
            docker ps -a
            
            echo -e "\n=== Backend Container Logs ==="
            docker logs backend_app --tail 50 || echo "Backend container not found"
            
            echo -e "\n=== Frontend Container Logs ==="
            docker logs frontend_app --tail 30 || echo "Frontend container not found"
            
            echo -e "\n=== Docker Compose Services ==="
            cd /home/${{ secrets.EC2_USERNAME }}/3-tier-app
            docker compose ps

      - name: Check Port Accessibility
        run: |
          echo "Testing if port 3500 is accessible..."
          nc -zv ${{ secrets.EC2_HOST }} 3500 -w 5 || echo "‚ö†Ô∏è Port 3500 is not accessible"
          
          echo "Testing if port 80 is accessible..."
          nc -zv ${{ secrets.EC2_HOST }} 80 -w 5 || echo "‚ö†Ô∏è Port 80 is not accessible"

      - name: Check Backend Health
        id: backend_health
        continue-on-error: true
        run: |
          echo "Checking backend at http://${{ secrets.EC2_HOST }}:3500/health"
          for i in {1..10}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 http://${{ secrets.EC2_HOST }}:3500/health 2>/dev/null || echo "000")
            echo "Attempt $i: HTTP Status $CODE"
            if [ "$CODE" = "200" ]; then
              echo "‚úÖ Backend is healthy!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "‚ùå Backend health check failed after 10 attempts"
          echo ""
          echo "‚ö†Ô∏è  TROUBLESHOOTING STEPS:"
          echo "1. Check EC2 Security Group - Port 3500 must be open"
          echo "   AWS Console ‚Üí EC2 ‚Üí Security Groups ‚Üí Inbound Rules"
          echo ""
          echo "2. Check RDS Security Group - Must allow EC2 connection"
          echo "   AWS Console ‚Üí RDS ‚Üí Security Groups ‚Üí Port 3306"
          echo ""
          echo "3. SSH into EC2 and check containers:"
          echo "   ssh ubuntu@${{ secrets.EC2_HOST }}"
          echo "   docker ps -a"
          echo "   docker logs backend_app"
          echo ""
          echo "4. Test backend locally on EC2:"
          echo "   curl http://localhost:3500/health"
          echo ""
          echo "status=failed" >> $GITHUB_OUTPUT

      - name: Check Frontend
        id: frontend_health
        continue-on-error: true
        run: |
          echo "Checking frontend at http://${{ secrets.EC2_HOST }}"
          for i in {1..5}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://${{ secrets.EC2_HOST }} || echo "000")
            echo "Attempt $i: HTTP Status $CODE"
            if [ "$CODE" = "200" ]; then
              echo "‚úÖ Frontend is healthy!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "‚ö†Ô∏è Frontend health check failed"
          echo "status=failed" >> $GITHUB_OUTPUT

  # ==================== NOTIFY ====================
  notify:
    needs: [deploy-to-ec2, health-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Result
        run: |
          echo "=========================================="
          echo "   DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "Deploy Status: ${{ needs.deploy-to-ec2.result }}"
          echo "Health Check Status: ${{ needs.health-check.result }}"
          echo ""
          
          if [ "${{ needs.deploy-to-ec2.result }}" = "success" ]; then
            echo "‚úÖ Deployment completed"
            echo ""
            echo "üîó Access your application:"
            echo "   Frontend: http://${{ secrets.EC2_HOST }}"
            echo "   Backend: http://${{ secrets.EC2_HOST }}:3500/health"
            echo ""
            
            if [ "${{ needs.health-check.result }}" != "success" ]; then
              echo "‚ö†Ô∏è  Health checks did not pass"
              echo ""
              echo "üìã Next steps:"
              echo "1. Check if containers are running on EC2"
              echo "2. Verify EC2 Security Group allows ports 80 and 3500"
              echo "3. Verify RDS Security Group allows EC2 connection"
              echo "4. Review container logs above"
            else
              echo "üéâ All health checks passed!"
            fi
          else
            echo "‚ùå Deployment failed"
            echo "Check the logs above for details"
          fi
          echo ""
          echo "=========================================="
